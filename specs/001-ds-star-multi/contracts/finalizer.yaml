openapi: 3.0.3
info:
  title: Compliance Finalizer Agent Contract
  description: |
    Contract for the Compliance Finalizer Agent that performs final validation before commits.
    Checks code quality, constitutional compliance, documentation sync, security,
    and requests explicit user approval for all git operations.
  version: 1.0.0

paths:
  /finalize:
    post:
      summary: Perform pre-commit validation
      description: |
        Validates all artifacts meet quality standards, constitutional principles,
        documentation is synchronized, no secrets present, and prepares commit.
        ALWAYS requests explicit user approval before ANY git operations.
      operationId: finalizeCommit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FinalizationRequest'
            examples:
              preCommit:
                summary: Finalize before commit
                value:
                  agent_id: quality.finalizer
                  task_id: 550e8400-e29b-41d4-a716-446655440000
                  phase: validation
                  artifact_paths:
                    code_files:
                      - src/sdd/agents/quality/verifier.py
                      - src/sdd/refinement/loop.py
                    test_files:
                      - tests/contract/test_verifier_contract.py
                      - tests/unit/test_verifier.py
                    docs_files:
                      - .docs/agents/quality/verifier/README.md
                      - CLAUDE.md
                  validation_checks:
                    - tests_passing
                    - code_coverage
                    - linting
                    - constitutional_compliance
                    - documentation_sync
                    - secrets_check
                  git_operation:
                    type: commit
                    message: "feat: Add verification agent with quality gates\n\nImplements FR-001 to FR-006 for binary quality gate decisions."
                    files_to_stage:
                      - src/sdd/agents/quality/verifier.py
                      - tests/contract/test_verifier_contract.py
      responses:
        '200':
          description: Finalization completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FinalizationResponse'
              examples:
                approved:
                  summary: All checks passed, awaiting user approval
                  value:
                    agent_id: quality.finalizer
                    task_id: 550e8400-e29b-41d4-a716-446655440000
                    success: true
                    output_data:
                      all_checks_passed: true
                      check_results:
                        tests_passing: true
                        code_coverage: true
                        linting: true
                        constitutional_compliance: true
                        documentation_sync: true
                        secrets_check: true
                      code_coverage_percent: 87.5
                      linting_errors: 0
                      constitutional_violations: []
                      documentation_updates_needed: []
                      secrets_found: []
                      formatted_files: []
                      git_approval_required: true
                      git_operation_summary: |
                        Commit 6 files with message:
                        feat: Add verification agent with quality gates

                        Implements FR-001 to FR-006 for binary quality gate decisions.
                    reasoning: All validation checks passed. Ready for commit pending user approval.
                    confidence: 0.97
                    next_actions:
                      - Request user approval for git commit
                      - Execute commit if approved
                      - Update metrics on success
                    timestamp: '2025-11-10T14:00:00Z'
                failed:
                  summary: Validation failed
                  value:
                    agent_id: quality.finalizer
                    task_id: 550e8400-e29b-41d4-a716-446655440000
                    success: true
                    output_data:
                      all_checks_passed: false
                      check_results:
                        tests_passing: false
                        code_coverage: true
                        linting: true
                        constitutional_compliance: false
                        documentation_sync: true
                        secrets_check: true
                      code_coverage_percent: 82.0
                      linting_errors: 0
                      constitutional_violations:
                        - Library-First principle: verifier logic not extracted to library
                        - Test-First principle: tests written after implementation
                      documentation_updates_needed: []
                      secrets_found: []
                      git_approval_required: false
                    reasoning: Constitutional violations block commit. Refactor required.
                    confidence: 0.93
                    next_actions:
                      - Extract verifier logic to standalone library
                      - Delete implementation and rewrite tests first
                      - Re-run finalization after refactoring
                    timestamp: '2025-11-10T14:05:00Z'

components:
  schemas:
    FinalizationRequest:
      type: object
      required:
        - agent_id
        - task_id
        - phase
        - artifact_paths
        - validation_checks
      properties:
        agent_id:
          type: string
          pattern: '^quality\.finalizer$'
        task_id:
          type: string
          format: uuid
        phase:
          type: string
          enum: [validation]
        artifact_paths:
          type: object
          properties:
            code_files:
              type: array
              items:
                type: string
            test_files:
              type: array
              items:
                type: string
            docs_files:
              type: array
              items:
                type: string
        validation_checks:
          type: array
          items:
            type: string
            enum:
              - tests_passing
              - code_coverage
              - linting
              - constitutional_compliance
              - documentation_sync
              - secrets_check
        git_operation:
          type: object
          nullable: true
          properties:
            type:
              type: string
              enum: [commit, push, tag, branch]
            message:
              type: string
            files_to_stage:
              type: array
              items:
                type: string

    FinalizationResponse:
      type: object
      required:
        - agent_id
        - task_id
        - success
        - output_data
        - reasoning
        - confidence
        - next_actions
        - timestamp
      properties:
        agent_id:
          type: string
        task_id:
          type: string
          format: uuid
        success:
          type: boolean
          description: Whether finalization process completed (not whether validation passed)
        output_data:
          $ref: '#/components/schemas/FinalizationResult'
        reasoning:
          type: string
        confidence:
          type: number
          minimum: 0.0
          maximum: 1.0
        next_actions:
          type: array
          items:
            type: string
        timestamp:
          type: string
          format: date-time

    FinalizationResult:
      type: object
      required:
        - all_checks_passed
        - check_results
        - git_approval_required
      properties:
        all_checks_passed:
          type: boolean
          description: Whether all validation checks passed
        check_results:
          type: object
          properties:
            tests_passing:
              type: boolean
            code_coverage:
              type: boolean
            linting:
              type: boolean
            constitutional_compliance:
              type: boolean
            documentation_sync:
              type: boolean
            secrets_check:
              type: boolean
        code_coverage_percent:
          type: number
          minimum: 0.0
          maximum: 100.0
          description: Code coverage percentage
        linting_errors:
          type: integer
          minimum: 0
          description: Number of linting errors
        constitutional_violations:
          type: array
          items:
            type: string
          description: Specific constitutional principle violations
        documentation_updates_needed:
          type: array
          items:
            type: string
          description: Documentation files needing updates
        secrets_found:
          type: array
          items:
            type: object
            properties:
              file:
                type: string
              line:
                type: integer
              secret_type:
                type: string
          description: Secrets detected in code
        formatted_files:
          type: array
          items:
            type: string
          description: Files that were auto-formatted
        git_approval_required:
          type: boolean
          description: Whether user approval needed for git operation
        git_operation_summary:
          type: string
          nullable: true
          description: Human-readable summary of proposed git operation
        user_approved:
          type: boolean
          nullable: true
          description: Whether user approved git operation (set after user response)
