openapi: 3.0.3
info:
  title: Auto-Debug Agent Contract
  description: |
    Contract for the Auto-Debug Agent that performs automatic error detection and repair.
    Classifies errors, generates constitutional-compliant fixes, validates repairs,
    and escalates after maximum iterations.
  version: 1.0.0

paths:
  /debug:
    post:
      summary: Automatically debug and repair code
      description: |
        Analyzes failed code execution, classifies error type, generates repair
        aligned with spec and constitutional principles, validates fix, and repeats
        up to max_iterations before escalating to human.
      operationId: autoDebug
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DebugRequest'
            examples:
              syntaxError:
                summary: Debug syntax error
                value:
                  agent_id: engineering.autodebug
                  task_id: 550e8400-e29b-41d4-a716-446655440000
                  phase: implementation
                  failed_code: |
                    def calculate_total(items):
                        total = 0
                        for item in items
                            total += item.price
                        return total
                  stack_trace: |
                    File "calculator.py", line 3
                        for item in items
                                        ^
                    SyntaxError: invalid syntax
                  test_expectations:
                    - Function returns sum of item prices
                    - Handles empty list gracefully
                  max_iterations: 5
                  context:
                    spec_path: /workspaces/sdd-agentic-framework/specs/003-cart/spec.md
      responses:
        '200':
          description: Debug attempt completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DebugResponse'
              examples:
                resolved:
                  summary: Error resolved successfully
                  value:
                    agent_id: engineering.autodebug
                    task_id: 550e8400-e29b-41d4-a716-446655440000
                    success: true
                    output_data:
                      resolved: true
                      total_iterations: 1
                      final_code: |
                        def calculate_total(items):
                            total = 0
                            for item in items:
                                total += item.price
                            return total
                      error_pattern: syntax
                      repair_summary: Added missing colon after for statement
                      attempts:
                        - iteration: 1
                          error_pattern: syntax
                          repair_action: Add colon after for statement (line 3)
                          test_result: passed
                    reasoning: Missing colon is common syntax error, straightforward fix
                    confidence: 0.98
                    next_actions:
                      - Commit repaired code
                      - Run full test suite
                    timestamp: '2025-11-10T12:00:00Z'
                escalated:
                  summary: Escalated after max iterations
                  value:
                    agent_id: engineering.autodebug
                    task_id: 550e8400-e29b-41d4-a716-446655440000
                    success: true
                    output_data:
                      resolved: false
                      escalated: true
                      total_iterations: 5
                      error_pattern: logic
                      escalation_context:
                        original_error: Complex algorithm logic error
                        attempted_repairs:
                          - Changed sorting algorithm
                          - Adjusted boundary conditions
                          - Refactored comparison logic
                        recommendation: Spec may need clarification on edge cases
                    reasoning: Logic error requires architectural decision beyond automated repair
                    confidence: 0.75
                    next_actions:
                      - Review specification for clarity
                      - Human review of attempted fixes
                    timestamp: '2025-11-10T12:05:00Z'

components:
  schemas:
    DebugRequest:
      type: object
      required:
        - agent_id
        - task_id
        - phase
        - failed_code
        - stack_trace
        - test_expectations
        - max_iterations
      properties:
        agent_id:
          type: string
          pattern: '^engineering\.autodebug$'
        task_id:
          type: string
          format: uuid
        phase:
          type: string
          enum: [implementation, validation]
        failed_code:
          type: string
          description: Code that failed execution
        stack_trace:
          type: string
          description: Full error stack trace
        test_expectations:
          type: array
          items:
            type: string
          description: Expected behavior from tests
        max_iterations:
          type: integer
          minimum: 1
          maximum: 5
          default: 5
          description: Maximum debug attempts
        context:
          $ref: '#/components/schemas/AgentContext'

    DebugResponse:
      type: object
      required:
        - agent_id
        - task_id
        - success
        - output_data
        - reasoning
        - confidence
        - next_actions
        - timestamp
      properties:
        agent_id:
          type: string
        task_id:
          type: string
          format: uuid
        success:
          type: boolean
          description: Whether debug process completed (not whether error resolved)
        output_data:
          $ref: '#/components/schemas/DebugSession'
        reasoning:
          type: string
        confidence:
          type: number
          minimum: 0.0
          maximum: 1.0
        next_actions:
          type: array
          items:
            type: string
        timestamp:
          type: string
          format: date-time

    DebugSession:
      type: object
      required:
        - resolved
        - total_iterations
        - error_pattern
      properties:
        resolved:
          type: boolean
          description: Whether error was successfully fixed
        escalated:
          type: boolean
          description: Whether escalated to human
          default: false
        total_iterations:
          type: integer
          minimum: 1
          maximum: 5
          description: Number of repair attempts
        final_code:
          type: string
          nullable: true
          description: Code after successful repair (if resolved)
        error_pattern:
          type: string
          enum: [syntax, type, name, null, import, logic, unknown]
          description: Classified error type
        repair_summary:
          type: string
          nullable: true
          description: Brief description of successful repair
        attempts:
          type: array
          items:
            $ref: '#/components/schemas/DebugAttempt'
          description: All repair attempts
        escalation_context:
          type: object
          nullable: true
          description: Context for human review (if escalated)
          properties:
            original_error:
              type: string
            attempted_repairs:
              type: array
              items:
                type: string
            recommendation:
              type: string

    DebugAttempt:
      type: object
      required:
        - iteration
        - error_pattern
        - repair_action
        - test_result
      properties:
        iteration:
          type: integer
          minimum: 1
          maximum: 5
        error_pattern:
          type: string
          enum: [syntax, type, name, null, import, logic, unknown]
        error_message:
          type: string
        stack_trace:
          type: string
        repair_action:
          type: string
          description: Description of repair attempt
        repaired_code:
          type: string
        test_result:
          type: string
          enum: [passed, failed, error]
        reasoning:
          type: string

    AgentContext:
      type: object
      properties:
        spec_path:
          type: string
          nullable: true
        plan_path:
          type: string
          nullable: true
        previous_outputs:
          type: array
          items:
            type: object
        cumulative_feedback:
          type: array
          items:
            type: string
