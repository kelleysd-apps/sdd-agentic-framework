openapi: 3.0.3
info:
  title: Verification Agent Contract
  description: |
    Contract for the Quality Verification Agent that makes binary quality gate decisions.
    Evaluates specifications, plans, and implementations against constitutional principles
    and quality standards.
  version: 1.0.0
  contact:
    name: SDD Framework
    url: https://github.com/sdd-agentic-framework

paths:
  /verify:
    post:
      summary: Verify quality of artifact
      description: |
        Evaluates an artifact (spec, plan, code) against quality standards and returns
        a binary decision (sufficient/insufficient) with detailed reasoning and feedback.
      operationId: verifyQuality
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerificationRequest'
            examples:
              planVerification:
                summary: Verify implementation plan
                value:
                  agent_id: quality.verifier
                  task_id: 550e8400-e29b-41d4-a716-446655440000
                  phase: planning
                  artifact_type: plan
                  artifact_path: /workspaces/sdd-agentic-framework/specs/001-ds-star-multi/plan.md
                  quality_thresholds:
                    completeness: 0.90
                    constitutional_compliance: 0.85
                    test_coverage: 0.80
                  context:
                    spec_path: /workspaces/sdd-agentic-framework/specs/001-ds-star-multi/spec.md
                    cumulative_feedback: []
      responses:
        '200':
          description: Verification completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VerificationResponse'
              examples:
                insufficient:
                  summary: Quality gate failed
                  value:
                    agent_id: quality.verifier
                    task_id: 550e8400-e29b-41d4-a716-446655440000
                    success: true
                    output_data:
                      decision: insufficient
                      quality_score: 0.72
                      dimension_scores:
                        completeness: 0.85
                        constitutional_compliance: 0.65
                        test_coverage: 0.70
                        spec_alignment: 0.90
                      feedback:
                        - Add contract tests for POST /api/users endpoint
                        - Extract auth logic to library per Library-First principle
                      violations:
                        - missing_contract_test
                        - library_first_violation
                      passed_checks:
                        - completeness
                        - spec_alignment
                    reasoning: Plan violates Library-First principle and lacks contract tests
                    confidence: 0.91
                    next_actions:
                      - Generate OpenAPI schemas for all endpoints
                      - Extract authentication logic to standalone library
                    timestamp: '2025-11-10T10:30:00Z'
                sufficient:
                  summary: Quality gate passed
                  value:
                    agent_id: quality.verifier
                    task_id: 550e8400-e29b-41d4-a716-446655440000
                    success: true
                    output_data:
                      decision: sufficient
                      quality_score: 0.93
                      dimension_scores:
                        completeness: 0.95
                        constitutional_compliance: 0.92
                        test_coverage: 0.90
                        spec_alignment: 0.95
                      feedback: []
                      violations: []
                      passed_checks:
                        - completeness
                        - constitutional_compliance
                        - test_coverage
                        - spec_alignment
                    reasoning: All quality dimensions meet or exceed thresholds
                    confidence: 0.95
                    next_actions:
                      - Proceed to implementation phase
                    timestamp: '2025-11-10T10:35:00Z'
        '400':
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal verification error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    VerificationRequest:
      type: object
      required:
        - agent_id
        - task_id
        - phase
        - artifact_type
        - artifact_path
        - quality_thresholds
      properties:
        agent_id:
          type: string
          pattern: '^quality\.verifier$'
          description: Agent identifier
        task_id:
          type: string
          format: uuid
          description: Unique task identifier
        phase:
          type: string
          enum: [specification, planning, implementation, validation]
          description: Current workflow phase
        artifact_type:
          type: string
          enum: [spec, plan, code, tests]
          description: Type of artifact being verified
        artifact_path:
          type: string
          description: Absolute path to artifact file
        quality_thresholds:
          type: object
          description: Minimum quality scores per dimension
          properties:
            completeness:
              type: number
              minimum: 0.0
              maximum: 1.0
              default: 0.90
            constitutional_compliance:
              type: number
              minimum: 0.0
              maximum: 1.0
              default: 0.85
            test_coverage:
              type: number
              minimum: 0.0
              maximum: 1.0
              default: 0.80
            spec_alignment:
              type: number
              minimum: 0.0
              maximum: 1.0
              default: 0.90
        context:
          $ref: '#/components/schemas/AgentContext'

    VerificationResponse:
      type: object
      required:
        - agent_id
        - task_id
        - success
        - output_data
        - reasoning
        - confidence
        - next_actions
        - timestamp
      properties:
        agent_id:
          type: string
          description: Agent that produced this output
        task_id:
          type: string
          format: uuid
          description: Task identifier
        success:
          type: boolean
          description: Whether verification completed (not whether artifact passed)
        output_data:
          $ref: '#/components/schemas/VerificationDecision'
        reasoning:
          type: string
          description: Human-readable explanation of decision
        confidence:
          type: number
          minimum: 0.0
          maximum: 1.0
          description: Confidence in decision
        next_actions:
          type: array
          items:
            type: string
          description: Suggested next steps
        metadata:
          type: object
          additionalProperties: true
          description: Additional structured data
        timestamp:
          type: string
          format: date-time
          description: When verification was performed

    VerificationDecision:
      type: object
      required:
        - decision
        - quality_score
        - dimension_scores
        - feedback
        - violations
        - passed_checks
      properties:
        decision:
          type: string
          enum: [sufficient, insufficient]
          description: Binary quality gate decision
        quality_score:
          type: number
          minimum: 0.0
          maximum: 1.0
          description: Overall quality score
        dimension_scores:
          type: object
          description: Scores per evaluation dimension
          properties:
            completeness:
              type: number
              minimum: 0.0
              maximum: 1.0
            constitutional_compliance:
              type: number
              minimum: 0.0
              maximum: 1.0
            test_coverage:
              type: number
              minimum: 0.0
              maximum: 1.0
            spec_alignment:
              type: number
              minimum: 0.0
              maximum: 1.0
        feedback:
          type: array
          items:
            type: string
          description: Actionable improvement suggestions
        violations:
          type: array
          items:
            type: string
          description: Specific issues identified
        passed_checks:
          type: array
          items:
            type: string
          description: Checks that passed

    AgentContext:
      type: object
      properties:
        spec_path:
          type: string
          nullable: true
          description: Path to feature specification
        plan_path:
          type: string
          nullable: true
          description: Path to implementation plan
        previous_outputs:
          type: array
          items:
            type: object
          description: History of agent outputs
        cumulative_feedback:
          type: array
          items:
            type: string
          description: Accumulated feedback
        refinement_state:
          type: object
          nullable: true
          description: Current refinement state

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Error message
        details:
          type: object
          additionalProperties: true
          description: Additional error details
