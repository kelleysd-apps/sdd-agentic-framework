# Todo Architecture Policy - Single Source of Truth (SSOT)

**Version**: 1.0.0
**Effective Date**: 2025-11-29
**Authority**: Constitution v1.6.0 - Principles VIII (Documentation Sync), X (Agent Delegation)
**Review Cycle**: Quarterly

---

## Purpose

This policy establishes the **Single Source of Truth (SSOT)** architecture for todo and task management across the SDD Framework. It ensures all agents, workflows, and team members work from one unified, authoritative task list while maintaining clear separation between different task scopes.

---

## SSOT Principle

### Core Mandate

**One comprehensive todo list serves as the authoritative source for all work.**

```
┌─────────────────────────────────────────────────────────────────┐
│                    TODO ARCHITECTURE SSOT                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              PROJECT-LEVEL TASKS.MD                      │   │
│  │         (specs/###-feature/tasks.md)                     │   │
│  │                                                          │   │
│  │  • Generated by /tasks command                          │   │
│  │  • Dependency-ordered implementation tasks              │   │
│  │  • Phase-organized (Setup → Tests → Core → Polish)      │   │
│  │  • Persists across sessions                             │   │
│  │  • Source of truth for feature implementation           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            ↓                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              SESSION-LEVEL TODOWRITE                     │   │
│  │           (Claude Code TodoWrite tool)                   │   │
│  │                                                          │   │
│  │  • Active work tracking within session                  │   │
│  │  • Real-time progress visibility                        │   │
│  │  • Derived from project-level tasks                     │   │
│  │  • Ephemeral (session-scoped)                           │   │
│  │  • Source of truth for current work focus               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                            ↓                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              AGENT-LEVEL TASK CONTEXT                    │   │
│  │        (.docs/agents/*/decisions/tasks/)                 │   │
│  │                                                          │   │
│  │  • Agent-specific task history                          │   │
│  │  • Completion records and decisions                     │   │
│  │  • Cross-session continuity                             │   │
│  │  • Audit trail for agent work                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Task Hierarchy

### Level 1: Project Tasks (specs/###-feature/tasks.md)

**Purpose**: Comprehensive, dependency-ordered implementation checklist for a feature.

**Characteristics**:
- Generated by `tasks-agent` via `/tasks` command
- Persists in version control
- Organized by implementation phase
- Contains full task details with file paths
- Marked with parallel execution indicators [P]
- Includes dependency relationships

**Format**:
```markdown
# Tasks: Feature Name

## Phase 3.1: Setup
- [ ] T001 Create project structure
- [ ] T002 Initialize dependencies

## Phase 3.2: Tests First (TDD)
- [ ] T003 [P] Contract test for endpoint A
- [ ] T004 [P] Contract test for endpoint B

## Phase 3.3: Core Implementation
- [ ] T005 Implement model in src/models/entity.py
- [ ] T006 Implement service in src/services/entity_service.py

## Dependencies
- T003, T004 must complete before T005, T006
- T005 blocks T006
```

**When to Update**:
- After `/tasks` command generates initial list
- When task scope changes significantly
- When dependencies are discovered/changed
- When tasks are completed (check off)

---

### Level 2: Session Tasks (TodoWrite Tool)

**Purpose**: Real-time tracking of active work within a Claude Code session.

**Characteristics**:
- Managed via `TodoWrite` tool
- Visible to user in real-time
- Ephemeral (session-scoped)
- Should reflect current work focus
- Limited to actionable items in progress

**States**:
| State | Meaning | Usage |
|-------|---------|-------|
| `pending` | Not yet started | Queued work items |
| `in_progress` | Currently being worked on | ONE task at a time |
| `completed` | Finished successfully | Mark immediately when done |

**Best Practices**:
```
1. ONLY ONE task should be "in_progress" at a time
2. Mark tasks "completed" IMMEDIATELY after finishing
3. Keep list focused (3-10 items max)
4. Derive from project-level tasks.md
5. Update frequently to show progress
```

**Format**:
```json
{
  "content": "Implement user model in src/models/user.py",
  "status": "in_progress",
  "activeForm": "Implementing user model"
}
```

---

### Level 3: Agent Task History (.docs/agents/*/decisions/tasks/)

**Purpose**: Persistent record of agent task execution for continuity and audit.

**Characteristics**:
- Organized by agent and department
- Includes completion timestamps
- Records decisions made during execution
- Enables cross-session continuity
- Supports performance analysis

**Directory Structure**:
```
.docs/agents/
├── product/
│   ├── tasks-agent/
│   │   └── decisions/
│   │       └── tasks/
│   │           ├── 2025-11-29-feature-001-tasks.md
│   │           └── task-generation-history.md
│   └── planning-agent/
│       └── decisions/
│           └── tasks/
├── engineering/
│   └── frontend-specialist/
│       └── decisions/
│           └── tasks/
└── shared/
    └── task-handoffs/
        └── context-transfers.md
```

---

## Task Flow Integration

### Creating Tasks (Project Level)

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   /specify  │ ──> │    /plan    │ ──> │   /tasks    │
│   (spec.md) │     │  (plan.md)  │     │ (tasks.md)  │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
                                    ┌─────────────────────┐
                                    │ specs/###-feature/  │
                                    │     tasks.md        │
                                    │ (PROJECT SSOT)      │
                                    └─────────────────────┘
```

### Executing Tasks (Session Level)

```
┌─────────────────────┐
│ specs/###-feature/  │
│     tasks.md        │
└─────────┬───────────┘
          │
          │ Read and derive
          ▼
┌─────────────────────┐     ┌─────────────────────┐
│   TodoWrite Tool    │ ──> │  User Visibility    │
│  (SESSION SSOT)     │     │  (Real-time UI)     │
└─────────┬───────────┘     └─────────────────────┘
          │
          │ On completion
          ▼
┌─────────────────────┐
│ Update tasks.md     │
│ (Check off [x])     │
└─────────────────────┘
```

### Recording Completion (Agent Level)

```
┌─────────────────────┐
│  Task Completed     │
└─────────┬───────────┘
          │
          ├──> Update TodoWrite (mark completed)
          │
          ├──> Update tasks.md (check off)
          │
          └──> Record in agent decisions/
               └── tasks/completion-log.md
```

---

## TodoWrite Usage Guidelines

### When to Use TodoWrite

**ALWAYS use** when:
- Task requires 3+ distinct steps
- User provides multiple items to complete
- Complex multi-step implementation
- Need to show progress to user
- Working on feature from tasks.md

**DON'T use** when:
- Single trivial task (< 3 steps)
- Quick questions or lookups
- Simple file reads
- Conversational responses

### TodoWrite Workflow

```
1. ANALYZE request
   └─ Count steps, identify complexity

2. CREATE todo list (if needed)
   └─ Use TodoWrite with all items as "pending"

3. START first task
   └─ Mark ONE item as "in_progress"

4. COMPLETE task
   └─ Mark as "completed" IMMEDIATELY

5. START next task
   └─ Mark next item as "in_progress"

6. REPEAT until all complete
```

### Example: Implementing Feature Tasks

**Bad** (batching completions):
```
[Work on task 1...]
[Work on task 2...]
[Work on task 3...]
[Now mark all as completed] ← DON'T DO THIS
```

**Good** (immediate updates):
```
[Mark task 1 in_progress]
[Work on task 1...]
[Mark task 1 completed, task 2 in_progress]
[Work on task 2...]
[Mark task 2 completed, task 3 in_progress]
[Work on task 3...]
[Mark task 3 completed]
```

---

## Synchronization Protocol

### Project ↔ Session Sync

When starting work on a feature:

1. **Read** `specs/###-feature/tasks.md`
2. **Identify** next uncompleted tasks
3. **Create** TodoWrite list with those tasks
4. **Work** through tasks (update TodoWrite)
5. **Update** tasks.md to reflect completions

### Cross-Session Continuity

When resuming work:

1. **Check** `specs/###-feature/tasks.md` for status
2. **Review** `.docs/agents/*/decisions/tasks/` for context
3. **Recreate** TodoWrite list from incomplete tasks
4. **Continue** work from last checkpoint

### Multi-Agent Coordination

When multiple agents work on same feature:

1. **task-orchestrator** owns overall task allocation
2. Each agent updates TodoWrite for their assigned tasks
3. Completed tasks recorded in agent's `decisions/tasks/`
4. **task-orchestrator** syncs back to tasks.md

---

## Task Status Definitions

### Project-Level (tasks.md)

| Marker | Meaning |
|--------|---------|
| `- [ ]` | Not started |
| `- [x]` | Completed |
| `- [~]` | In progress (optional) |
| `- [!]` | Blocked (optional) |

### Session-Level (TodoWrite)

| Status | Meaning | Rules |
|--------|---------|-------|
| `pending` | Queued | Any number allowed |
| `in_progress` | Active work | **ONE at a time** |
| `completed` | Done | Mark immediately |

### Agent-Level (decisions/tasks/)

| Status | Meaning |
|--------|---------|
| `assigned` | Allocated to agent |
| `started` | Work begun |
| `completed` | Successfully finished |
| `handed_off` | Transferred to another agent |
| `blocked` | Cannot proceed |

---

## Integration with SDD Workflow

### /tasks Command Integration

The `/tasks` command generates the project-level SSOT:

```bash
# Generates tasks.md from plan artifacts
/tasks

# Output: specs/###-feature/tasks.md
# - Dependency-ordered tasks
# - TDD-compliant (tests before implementation)
# - Phase-organized
# - Parallel execution markers
```

### /finalize Command Integration

The `/finalize` command validates task completion:

```bash
# Validates all tasks completed before commit
/finalize

# Checks:
# - All tasks.md items checked off
# - Tests passing
# - Constitutional compliance
```

---

## Audit and Compliance

### Task Audit Trail

Every task completion should log:

```yaml
task_id: T005
completed_at: 2025-11-29T14:30:00Z
completed_by: frontend-specialist
duration_minutes: 45
files_modified:
  - src/models/user.py
  - tests/unit/test_user.py
constitutional_compliance: true
notes: "Implemented per data-model.md specification"
```

### Compliance Checks

| Requirement | Enforcement |
|-------------|-------------|
| TDD order | Tests tasks before implementation tasks |
| SSOT sync | TodoWrite reflects tasks.md |
| Immediate updates | Completion marked when done |
| One active | Single in_progress task |

---

## Quick Reference

### For Agents

```
1. Read specs/###-feature/tasks.md for project tasks
2. Use TodoWrite for session tracking
3. Mark tasks completed IMMEDIATELY
4. Keep ONE task in_progress at a time
5. Sync completions back to tasks.md
6. Record decisions in .docs/agents/*/decisions/tasks/
```

### For Users

```
1. Generate tasks with /tasks command
2. View progress via TodoWrite UI
3. Check tasks.md for overall status
4. Use /finalize before committing
```

### Task Creation Checklist

- [ ] Tasks derived from plan.md artifacts
- [ ] TDD order enforced (tests first)
- [ ] Dependencies documented
- [ ] Parallel tasks marked [P]
- [ ] File paths specified
- [ ] Acceptance criteria clear

---

## References

- Constitution v1.6.0: `.specify/memory/constitution.md`
- Tasks Template: `.specify/templates/tasks-template.md`
- Tasks Agent: `.claude/agents/product/tasks-agent.md`
- Tasks Command: `.claude/commands/tasks.md`

---

**Policy Version**: 1.0.0
**Approved By**: Constitutional Authority
**Next Review**: 2026-02-28
